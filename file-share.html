<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MeetMate - 자료 공유</title>
    <link rel="stylesheet" href="meetmate.css" />
    <script src="meetmate.js"></script>
    <style>
      .content {
        align-items: center;
        justify-content: center;
        flex: 1;
        padding: 48px;
        max-width: 800px;
        margin-right: 315px;
        min-height: calc(100vh - 80px);
      }
      .main-container {
        display: flex;
        justify-content: center;
      }
      .content h2 {
        text-align: center;
      }
      .material-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        padding: 16px;
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .card-title {
        font-weight: bold;
        font-size: 16px;
      }

      .delete-btn {
        background: none;
        border: none;
        font-size: 16px;
        cursor: pointer;
        color: #999;
      }

      .card-meta {
        font-size: 13px;
        color: #666;
      }

      .dday {
        font-weight: bold;
        color: #f36856;
      }

      .link-btn {
        text-align: center;
        display: inline-block;
        background-color: #f8f9fa;
        color: #333;
        text-decoration: none;
        padding: 8px 14px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 13px;
        transition: all 0.2s ease;
      }

      .link-btn:hover {
        background-color: #e9ecef;
        border-color: #bbb;
        color: #222;
      }
      .card-title-wrapper {
        text-align: center;
      }

      .card-title {
        margin: 0;
        font-size: 16px;
        font-weight: bold;
      }

      .card-desc {
        font-size: 13px;
        color: #555;
        margin: 0;
      }
      .drive-upload-btn {
        padding: 4px 8px;
        font-size: 11px;
        font-weight: bold;
        border-radius: 6px;
        background-color: #f1f3f5;
        border: 1px solid #ccc;
        transition: all 0.2s;
        text-decoration: none;
        color: #333;
      }
      .drive-upload-btn:hover {
        background-color: #e2e6ea;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>
        <a href="main-home.html" style="text-decoration: none; color: inherit"
          >MeetMate</a
        >
      </h1>
      <nav class="topnav">
        <ul>
          <li>
            <a href="group.html">일정 조율</a>
          </li>
          <li>
            <a href="program.html">역할 분담</a>
          </li>
          <li>
            <a href="map.html">회의 장소</a>
          </li>
          <li class="active">
            <a href="file-share.html">자료 공유</a>
          </li>
          <li>
            <a href="group-result.html">전체 요약</a>
          </li>
        </ul>
      </nav>
      <div class="top-buttons" id="auth-buttons">
        <!-- 동적으로 내용 삽입됨 -->
      </div>
    </header>

    <div class="main-container">
      <!-- content -->
      <div class="content">
        <h2>자료 공유</h2>
        <a
          href="https://drive.google.com/drive/my-drive"
          target="_blank"
          class="primary drive-upload-btn"
          style="
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
          "
        >
          <span style="font-size: 20px"></span>
          <span style="font-size: 15px">Google Drive에 자료 업로드</span>
        </a>

        <form
          id="uploadForm"
          class="form"
          style="
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
          "
        >
          <input
            type="text"
            id="title"
            placeholder="자료 제목"
            required
            style="flex: 1 1 100%; padding: 10px"
          />
          <input
            type="date"
            id="deadline"
            required
            style="flex: 1 1 30%; padding: 10px"
          />
          <input
            type="url"
            id="link"
            placeholder="공유 링크 (https://drive.google.com/...)"
            required
            style="flex: 1 1 65%; padding: 10px"
          />
          <input
            type="text"
            id="comment"
            placeholder="자료 설명 (선택)"
            style="flex: 1 1 100%; padding: 10px"
          />
          <button type="submit" class="primary" style="margin-top: 8px">
            등록
          </button>
        </form>

        <div
          id="fileList"
          style="
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
            padding-bottom: 8px;
          "
        ></div>
      </div>
      <!-- 오른쪽 사이드 바 -->
      <div class="side-panel">
        <div class="card">
          <div id="today-date">📅 오늘 날짜: ...</div>
          <div id="current-time">🕒 현재 시간: ...</div>
        </div>
        <div class="card motivation">
          🩶 오늘도 좋은 하루 되세요!<br />함께하는 일정은 더 소중해요.
        </div>
      </div>
    </div>
    <script>
      // D-DAY 계산 함수
      function getDdayLabel(deadlineStr) {
        const today = new Date();
        const deadline = new Date(deadlineStr);

        const todayDate = new Date(
          today.getFullYear(),
          today.getMonth(),
          today.getDate()
        );
        const deadlineDate = new Date(
          deadline.getFullYear(),
          deadline.getMonth(),
          deadline.getDate()
        );

        const diffTime = deadlineDate - todayDate;
        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays > 0) return `D-${diffDays}`;
        else if (diffDays === 0) return `D-DAY`;
        else return `D+${Math.abs(diffDays)}`;
      }

      const form = document.getElementById("uploadForm");
      const fileList = document.getElementById("fileList");

      // ✅ 저장 키를 전체요약과 맞추기 위해 fileShare로 변경
      let files = JSON.parse(localStorage.getItem("fileShare") || "[]");

      function saveFiles() {
        localStorage.setItem("fileShare", JSON.stringify(files));
      }

      function renderFiles() {
        fileList.innerHTML = "";
        files.forEach((file, index) => {
          const ddayLabel = getDdayLabel(file.date); // ✅ 속성명 변경: deadline → date
          const card = document.createElement("div");
          card.className = "material-card";
          card.innerHTML = `
              <div class="card-header">
                <div class="card-title-wrapper">
                  <h3 class="card-title">🗂 ${file.title}</h3>
                </div>
                <button class="delete-btn" onclick="deleteFile(${index})">❌</button>
              </div>
              <p class="card-meta">마감: ${
                file.date
              } <span class="dday">(${ddayLabel})</span></p>
              <a href="${
                file.link
              }" target="_blank" class="link-btn">🔗 Drive 링크 열기</a>
              <p class="card-desc">📝 ${file.desc || "설명 없음"}</p>
            `;
          fileList.appendChild(card);
        });
      }

      window.deleteFile = function (i) {
        if (confirm("이 자료를 삭제할까요?")) {
          files.splice(i, 1);
          saveFiles();
          renderFiles();
        }
      };

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const title = document.getElementById("title").value;
        const date = document.getElementById("deadline").value;
        const link = document.getElementById("link").value;
        const desc = document.getElementById("comment").value;

        // ✅ 저장 형식 맞춤
        files.push({ title, date, link, desc });

        saveFiles();
        renderFiles();
        form.reset();
      });

      renderFiles();

      const username = localStorage.getItem("user");
      const topArea = document.getElementById("auth-buttons");

      if (username && username !== "null") {
        topArea.innerHTML = `
        <span>${username}님 환영합니다</span>
        <button onclick="logout()">로그아웃</button>
      `;
      } else {
        topArea.innerHTML = `
        <button onclick="window.location.href='login.html'">로그인</button>
      `;
      }

      function logout() {
        localStorage.removeItem("user");
        location.reload();
      }
    </script>
  </body>
</html>
